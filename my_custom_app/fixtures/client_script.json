[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Task",
  "enabled": 1,
  "modified": "2025-09-11 18:09:54.658109",
  "module": "Projects",
  "name": "Task Total Rate Calculation",
  "script": "frappe.ui.form.on(\"Task\", {\n    refresh: function(frm) {\n        console.log(\"[Task] Form refreshed:\", frm.doc.name);\n        frm.trigger(\"calculate_task_cost\");\n    },\n\n    // Fires when Task Cost quantity changes\n    custom_quantity: function(frm) {\n        console.log(\"[Task] Task Cost Quantity changed:\", frm.doc.custom_quantity);\n        frm.trigger(\"calculate_task_cost\");\n    },\n\n    // Calculate Task Cost section totals\n    calculate_task_cost: function(frm) {\n        let total_material_rate = 0;\n\n        (frm.doc.custom_materials_required || []).forEach(row => {\n            total_material_rate += row.total_rate || 0;\n            console.log(\"[Task] Child row:\", row.material_name, \"Total Rate:\", row.total_rate);\n        });\n\n        console.log(\"[Task] Total Material Rate:\", total_material_rate);\n\n        frm.set_value(\"custom_rate_per_unit\", total_material_rate);\n        frm.set_value(\"custom_total_rate\", (frm.doc.custom_quantity || 0) * total_material_rate);\n    }\n});\n\n\nfrappe.ui.form.on(\"Task Materials\", {\n    // Fires when a row is added or removed from the child table\n    custom_materials_required_add: function(frm) {\n        console.log(\"[Task] Row added to materials\");\n        frm.trigger(\"calculate_task_cost\");\n    },\n    custom_materials_required_remove: function(frm) {\n        console.log(\"[Task] Row removed from materials\");\n        frm.trigger(\"calculate_task_cost\");\n    },\n\n    // Fires when a row is rendered in popup or inline\n    // custom_materials_required_on_form_rendered: function(frm, grid, doc) {\n    //     console.log(\"[Task] Child row rendered:\", doc.material_name);\n    // },\n    \n    quantity: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        row.total_rate = (row.quantity || 0) * (row.rate_per_unit || 0);\n\n        console.log(\"[Task Materials] Quantity changed ->\",\n            \"Material:\", row.material_name,\n            \"Quantity:\", row.quantity,\n            \"Rate per Unit:\", row.rate_per_unit,\n            \"Total Rate:\", row.total_rate);\n\n        frm.refresh_field(\"custom_materials_required\");\n        frm.trigger(\"calculate_task_cost\");\n    },\n\n    rate_per_unit: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        row.total_rate = (row.quantity || 0) * (row.rate_per_unit || 0);\n\n        console.log(\"[Task Materials] Rate changed ->\",\n            \"Material:\", row.material_name,\n            \"Quantity:\", row.quantity,\n            \"Rate per Unit:\", row.rate_per_unit,\n            \"Total Rate:\", row.total_rate);\n\n        frm.refresh_field(\"custom_materials_required\");\n        frm.trigger(\"calculate_task_cost\");\n    }\n});\n",
  "view": "Form"
 }
]